@page "/"
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS
@using Markdig

<PageTitle>Project Reporting</PageTitle>

@if (Report is null)
{
    <FluentCard Style="padding:1rem; margin-bottom:1rem;">
        <h2>Select a Project</h2>
        @if (IsLoadingProjects)
        {
            <FluentProgressRing/>
            <p>Loading projects...</p>
        }
        else if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <FluentMessageBar Intent="MessageIntent.Error">@ErrorMessage</FluentMessageBar>
        }
        else if (Projects is null || Projects.Count == 0)
        {
            <p>No active projects found.</p>
        }
        else
        {
            <FluentDataGrid Items="@Projects.AsQueryable()" GridTemplateColumns="2fr 1fr 1fr 1fr 1fr" GenerateFooter="false">
                <PropertyColumn Property="@(p => p.ProjectName)" Title="Project Name" />
                <PropertyColumn Property="@(p => p.Status)" Title="Status" />
                <PropertyColumn Property="@(p => p.Manager)" Title="Manager" />
                <PropertyColumn Property="@(p => p.Company)" Title="Company" />
                <TemplateColumn Title="Actions">
                    <FluentButton Appearance="Appearance.Accent" 
                                  OnClick="@(() => GenerateReport(context.ProjectId))" 
                                  Disabled="IsGeneratingReport">
                        @(IsGeneratingReport && GeneratingProjectId == context.ProjectId ? "Generating..." : "Generate Report")
                    </FluentButton>
                </TemplateColumn>
            </FluentDataGrid>
        }
    </FluentCard>
}
else
{
    <FluentCard Style="padding:1rem; margin-bottom:1rem;">
        <FluentStack Orientation="Orientation.Horizontal" Gap="10">
            <FluentButton Appearance="Appearance.Outline" OnClick="BackToProjectList">← Back to Project List</FluentButton>
            <FluentButton Appearance="Appearance.Outline" OnClick="DownloadPdf" Disabled="IsPdfLoading">@(IsPdfLoading ? "Generating PDF..." : "Download PDF")</FluentButton>
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <FluentMessageBar Intent="MessageIntent.Error">@ErrorMessage</FluentMessageBar>
            }
        </FluentStack>
    </FluentCard>

    <FluentCard Style="padding:1rem;">
        <h2>@Report.ProjectName (#@Report.ProjectId)</h2>
        <p>
            <b>Status:</b> @Report.Summary?.Status
        </p>
        <p><b>Manager:</b> @Report.Summary?.Manager | <b>Company:</b> @Report.Summary?.Company</p>
        <p><b>Timeline:</b> @Report.Timeline?.PlannedDays d planned / @Report.Timeline?.TotalDays d actual (Var: @Report.Timeline?.VarianceDays)</p>
        <p><b>Budget:</b> @Report.Budget?.EstimatedHours h est / @Report.Budget?.ActualHours h actual (Var: @Report.Budget?.VarianceHours)</p>

        @if (!string.IsNullOrWhiteSpace(Report.AiGeneratedSummary))
        {
            <FluentAccordion>
                <FluentAccordionItem Heading="AI Summary">
                    <FluentIcon Value="@(new Icons.Regular.Size20.Globe())" Color="Color.Neutral" Slot="start" />
                    <div>@(new MarkupString(AiSummaryHtml))</div>
                </FluentAccordionItem>
            </FluentAccordion>
        }

        <FluentTabs ActiveTabId="phasesTab">
            <FluentTab Id="phasesTab" Label="Phases">
                @if (Report.Phases is null || Report.Phases.Count == 0)
                {
                    <p>No phases.</p>
                }
                else
                {
                    <FluentDataGrid Items="@Report.Phases.AsQueryable()" GenerateFooter="false">
                        <PropertyColumn Property="@(p => p.PhaseName)" Title="Name"/>
                        <PropertyColumn Property="@(p => p.Status)" Title="Status"/>
                        <PropertyColumn Property="@(p => p.EstimatedHours)" Title="Est Hrs"/>
                        <PropertyColumn Property="@(p => p.ActualHours)" Title="Actual Hrs"/>
                    </FluentDataGrid>
                }
            </FluentTab>
            <FluentTab Id="ticketsTab" Label="Tickets">
                @if (Report.Tickets is null || Report.Tickets.Count == 0)
                {
                    <p>No tickets.</p>
                }
                else
                {
                    <FluentDataGrid Items="@Report.Tickets.AsQueryable()" GenerateFooter="false">
                        <PropertyColumn Property="@(t => t.TicketNumber)" Title="Number"/>
                        <PropertyColumn Property="@(t => t.Summary)" Title="Summary"/>
                        <PropertyColumn Property="@(t => t.Status)" Title="Status"/>
                        <PropertyColumn Property="@(t => t.EstimatedHours)" Title="Est Hrs"/>
                        <PropertyColumn Property="@(t => t.ActualHours)" Title="Actual Hrs"/>
                    </FluentDataGrid>
                }
            </FluentTab>
        </FluentTabs>
    </FluentCard>
}

@code {
    List<ProjectListItem>? Projects;
    ProjectCompletionReportResponse? Report;
    bool IsLoadingProjects;
    bool IsGeneratingReport;
    int GeneratingProjectId;
    bool IsPdfLoading;
    string? ErrorMessage;
    string AiSummaryHtml => Report?.AiGeneratedSummary is null ? string.Empty : Markdown.ToHtml(Report.AiGeneratedSummary);

    protected override async Task OnInitializedAsync()
    {
        await LoadProjects();
    }

    async Task LoadProjects()
    {
        ErrorMessage = null;
        IsLoadingProjects = true;
        try
        {
            var response = await Http.GetAsync("api/projects");
            if (!response.IsSuccessStatusCode)
            {
                ErrorMessage = $"Failed to load projects: {response.StatusCode}";
                return;
            }
            Projects = await response.Content.ReadFromJsonAsync<List<ProjectListItem>>();
        }
        catch (Exception)
        {
            ErrorMessage = "An error occurred while loading projects. Please try again.";
        }
        finally
        {
            IsLoadingProjects = false;
        }
    }

    async Task GenerateReport(int projectId)
    {
        ErrorMessage = null;
        IsGeneratingReport = true;
        GeneratingProjectId = projectId;
        StateHasChanged();
        try
        {
            var req = new ProjectCompletionReportRequest { ProjectId = projectId };
            var httpResp = await Http.PostAsJsonAsync("api/reports/project-completion", req);
            if (!httpResp.IsSuccessStatusCode)
            {
                ErrorMessage = $"Failed to generate report: {httpResp.StatusCode}";
            }
            else
            {
                Report = await httpResp.Content.ReadFromJsonAsync<ProjectCompletionReportResponse>();
            }
        }
        catch (Exception)
        {
            ErrorMessage = "An error occurred while generating the report. Please try again.";
        }
        finally
        {
            IsGeneratingReport = false;
        }
    }

    void BackToProjectList()
    {
        Report = null;
        ErrorMessage = null;
    }

    async Task DownloadPdf()
    {
        if (Report is null) return;
        ErrorMessage = null;
        IsPdfLoading = true;
        try
        {
            var httpResp = await Http.PostAsJsonAsync("api/reports/project-completion/pdf", Report);
            if (!httpResp.IsSuccessStatusCode)
            {
                ErrorMessage = $"Failed to generate PDF: {httpResp.StatusCode}";
                return;
            }

            var bytes = await httpResp.Content.ReadAsByteArrayAsync();
            var base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("saveFile", base64, $"project-{Report.ProjectId}-completion-report.pdf", "application/pdf");
        }
        catch (Exception)
        {
            ErrorMessage = "An error occurred while generating the PDF. Please try again.";
        }
        finally
        {
            IsPdfLoading = false;
        }
    }
}